<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Agency Finder - Real Estate Agencies Database</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .agency-type-marbella { background-color: #e8f5e8; }
        .agency-type-polish { background-color: #e3f2fd; }
        .agency-type-gemini_discovered { background-color: #fff3e0; }

        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }

        .website-link {
            color: #0d6efd;
            text-decoration: none;
        }
        .website-link:hover {
            text-decoration: underline;
        }

        .navbar-brand {
            font-weight: bold;
        }

        .table th {
            background-color: #f8f9fa;
            border-top: 2px solid #dee2e6;
        }

        .badge-marbella { background-color: #28a745; }
        .badge-polish { background-color: #007bff; }
        .badge-gemini { background-color: #fd7e14; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-building"></i> Gemini Agency Finder
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    Real Estate Agencies Database - Costa del Sol & Poland
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Statistics Dashboard -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title text-primary">Total Agencies</h5>
                        <h2 class="card-text" id="total-agencies">0</h2>
                        <p class="text-muted">Last updated: <span id="last-updated"></span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title text-success">Marbella Based</h5>
                        <h2 class="card-text" id="marbella-count">0</h2>
                        <p class="text-muted">Physical locations</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title text-info">Polish Agencies</h5>
                        <h2 class="card-text" id="polish-count">0</h2>
                        <p class="text-muted">Costa del Sol specialists</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title text-warning">AI Discovered</h5>
                        <h2 class="card-text" id="gemini-count">0</h2>
                        <p class="text-muted">Gemini AI findings</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Agency Distribution by Type</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="agencyChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Table -->
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="card-title mb-0">Real Estate Agencies Database</h5>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-primary btn-sm me-2" id="export-csv">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="reset-filters">
                            <i class="fas fa-undo"></i> Reset Filters
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="agencies-table" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Website</th>
                                <th>Phone</th>
                                <th>Address</th>
                                <th>Description</th>
                                <th>Discovery Date</th>
                            </tr>
                        </thead>
                        <tbody id="agencies-body">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-3">
        <div class="container text-center">
            <p class="text-muted mb-0">
                Gemini Agency Finder - Costa del Sol Real Estate Agencies Database |
                Data sourced from AI-powered discovery and manual research |
                <a href="https://github.com/yourusername/gemini-agency-finder" target="_blank">View on GitHub</a>
            </p>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/responsive.bootstrap5.min.js"></script>

    <script>
        let agenciesData = [];
        let agenciesTable;

        // Load data from JSON file
        async function loadAgenciesData() {
            try {
                const response = await fetch('./agencies.json');
                agenciesData = await response.json();
                initializeDashboard();
                initializeTable();
            } catch (error) {
                console.error('Error loading agencies data:', error);
                document.getElementById('agencies-body').innerHTML =
                    '<tr><td colspan="7" class="text-center text-danger">Error loading data. Please check console for details.</td></tr>';
            }
        }

        function initializeDashboard() {
            // Calculate statistics
            const totalAgencies = agenciesData.length;
            const marbellaCount = agenciesData.filter(a => a.type === 'marbella').length;
            const polishCount = agenciesData.filter(a => a.type === 'polish').length;
            const geminiCount = agenciesData.filter(a => a.type === 'gemini_discovered').length;

            // Update stats cards
            document.getElementById('total-agencies').textContent = totalAgencies.toLocaleString();
            document.getElementById('marbella-count').textContent = marbellaCount.toLocaleString();
            document.getElementById('polish-count').textContent = polishCount.toLocaleString();
            document.getElementById('gemini-count').textContent = geminiCount.toLocaleString();

            // Set last updated date
            const latestDate = agenciesData
                .map(a => new Date(a.additional_info?.match(/(\d{4}-\d{2}-\d{2})/)?.[1] || '2025-01-01'))
                .sort((a, b) => b - a)[0];
            document.getElementById('last-updated').textContent = latestDate.toLocaleDateString();

            // Create chart
            const ctx = document.getElementById('agencyChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Marbella Based', 'Polish Agencies', 'AI Discovered'],
                    datasets: [{
                        data: [marbellaCount, polishCount, geminiCount],
                        backgroundColor: ['#28a745', '#007bff', '#fd7e14'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function initializeTable() {
            // Initialize DataTable
            agenciesTable = $('#agencies-table').DataTable({
                data: agenciesData,
                columns: [
                    {
                        data: 'name',
                        render: function(data, type, row) {
                            return `<strong>${data}</strong>`;
                        }
                    },
                    {
                        data: 'type',
                        render: function(data, type, row) {
                            const badges = {
                                'marbella': '<span class="badge badge-marbella">Marbella</span>',
                                'polish': '<span class="badge badge-polish">Polish</span>',
                                'gemini_discovered': '<span class="badge badge-gemini">AI Found</span>'
                            };
                            return badges[data] || data;
                        }
                    },
                    {
                        data: 'website',
                        render: function(data, type, row) {
                            if (data && data.trim()) {
                                const url = data.startsWith('http') ? data : `https://${data}`;
                                return `<a href="${url}" target="_blank" class="website-link">${data}</a>`;
                            }
                            return '<span class="text-muted">Not available</span>';
                        }
                    },
                    {
                        data: 'phone',
                        render: function(data, type, row) {
                            return data && data.trim() ? data : '<span class="text-muted">Not available</span>';
                        }
                    },
                    {
                        data: 'address',
                        render: function(data, type, row) {
                            return data && data.trim() ? data : '<span class="text-muted">Not available</span>';
                        }
                    },
                    {
                        data: 'description',
                        render: function(data, type, row) {
                            if (data && data.trim()) {
                                // Truncate long descriptions
                                const truncated = data.length > 100 ? data.substring(0, 100) + '...' : data;
                                return `<span title="${data}">${truncated}</span>`;
                            }
                            return '<span class="text-muted">No description</span>';
                        }
                    },
                    {
                        data: 'additional_info',
                        render: function(data, type, row) {
                            if (data && data.includes('Discovered via Gemini AI on')) {
                                const dateMatch = data.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/);
                                if (dateMatch) {
                                    const date = new Date(dateMatch[1]);
                                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                                }
                            }
                            return data || '<span class="text-muted">Unknown</span>';
                        }
                    }
                ],
                responsive: true,
                pageLength: 25,
                order: [[0, 'asc']],
                language: {
                    search: "Search agencies:",
                    lengthMenu: "Show _MENU_ agencies per page",
                    info: "Showing _START_ to _END_ of _TOTAL_ agencies",
                    infoEmpty: "No agencies found",
                    infoFiltered: "(filtered from _MAX_ total agencies)"
                },
                initComplete: function() {
                    // Add row styling based on agency type
                    this.api().rows().every(function() {
                        const data = this.data();
                        const row = this.node();

                        if (data.type === 'marbella') {
                            $(row).addClass('agency-type-marbella');
                        } else if (data.type === 'polish') {
                            $(row).addClass('agency-type-polish');
                        } else if (data.type === 'gemini_discovered') {
                            $(row).addClass('agency-type-gemini_discovered');
                        }
                    });
                }
            });

            // Export to CSV functionality
            $('#export-csv').on('click', function() {
                const visibleData = agenciesTable.rows({ search: 'applied' }).data().toArray();

                if (visibleData.length === 0) {
                    alert('No data to export. Please adjust your filters.');
                    return;
                }

                const csvContent = [
                    ['Name', 'Type', 'Website', 'Phone', 'Address', 'Description', 'Discovery Info'],
                    ...visibleData.map(row => [
                        row.name,
                        row.type,
                        row.website,
                        row.phone,
                        row.address,
                        row.description,
                        row.additional_info
                    ])
                ].map(row => row.map(field => `"${field || ''}"`).join(',')).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `agencies_export_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            });

            // Reset filters
            $('#reset-filters').on('click', function() {
                agenciesTable.search('').columns().search('').draw();
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', loadAgenciesData);
    </script>
</body>
</html>
